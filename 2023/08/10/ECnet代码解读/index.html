<!DOCTYPE html>
<html lang="zh-Hans">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="x5-fullscreen" content="true">
<meta name="full-screen" content="yes">
<meta name="theme-color" content="#317EFB" />
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=0" name="viewport">
<meta name="description" content="数据处理部分代码#data.py# 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959">
<meta property="og:type" content="article">
<meta property="og:title" content="ECnet代码解读（一）">
<meta property="og:url" content="http://example.com/2023/08/10/ECnet%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB/index.html">
<meta property="og:site_name" content="The Cabin of Hamzone">
<meta property="og:description" content="数据处理部分代码#data.py# 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959">
<meta property="og:locale">
<meta property="article:published_time" content="2023-08-10T08:22:43.000Z">
<meta property="article:modified_time" content="2023-08-10T09:08:04.936Z">
<meta property="article:author" content="Li Hanzhang">
<meta name="twitter:card" content="summary">


<title >ECnet代码解读（一）</title>

<!-- Favicon -->

    <link href='/Logo.svg?v=2.0.9' rel='icon' type='image/png' sizes='16x16' ></link>


    <link href='/Logo.svg?v=2.0.9' rel='icon' type='image/png' sizes='32x32' ></link>


    <link href='/Logo.svg?v=2.0.9' rel='apple-touch-icon' sizes='180x180' ></link>


    <link href='/site.webmanifest' rel='manifest' ></link>


<!-- Plugin -->




    
<link rel="stylesheet" href="/css/plugins/bootstrap.row.css">

    
<link rel="stylesheet" href="https://npm.elemecdn.com/locomotive-scroll@4.1.4/dist/locomotive-scroll.min.css">

    
<link rel="stylesheet" href="https://npm.elemecdn.com/@fancyapps/ui@4.0/dist/fancybox.css">

    
    




<!-- Icon -->

    
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_4177738_vsqmc23e2y.css">




<!-- Variable -->
<script>window.ASYNC_CONFIG = {"hostname":"example.com","author":"Li Hanzhang","root":"/","typed_text":["Always Learning","Always Coding","Always Improving"],"theme_version":"2.0.9","theme":{"switch":true,"default":"style-light"},"favicon":{"logo":"Logo.svg","icon16":"Logo.svg","icon32":"Logo.svg","appleTouchIcon":"Logo.svg","webmanifest":"/site.webmanifest","visibilitychange":true,"hidden":"failure.ico","showText":"(/≧▽≦/)咦！又好了！","hideText":"(●—●)喔哟，崩溃啦！"},"i18n":{"placeholder":"搜索文章...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）","author":"本文作者：","copyright_link":"本文链接：","copyright_license_title":"版权声明：","copyright_license_content":"本博客所有文章除特别声明外，均默认采用 undefined 许可协议。","copy_success":"复制成功","copy_failure":"复制失败","open_read_mode":"进入阅读模式","exit_read_mode":"退出阅读模式","notice_outdate_message":"距离上次更新已经 undefined 天了, 文章内容可能已经过时。","just":"刚刚","min":"分钟前","hour":"小时前","day":"天前","month":"个月前"},"swup":false,"plugin":{"flickr_justified_gallery":"https://npm.elemecdn.com/flickr-justified-gallery@latest/dist/fjGallery.min.js"},"icons":{"sun":"icon-rijian","moon":"icon-yueduye-yejianmoshi","play":"icon-24gf-playCircle","email":"icon-youxiang","next":"icon-jinrushiyan","calendar":"icon-riqi","clock":"icon-shijian","user":"icon-totop","back_top":"fas fa-arrow-up","close":"icon-anniu_guanbi","search":"icon-sousuo","reward":"icon-dashang","user_tag":"fas fa-user-alt","toc_tag":"fas fa-th-list","read":"icon-read","arrows":"icon-shangxiazhankai","double_arrows":"icon-shangxiazhankai","copy":"icon-fuzhi"},"icontype":"font","highlight":{"plugin":"highlighjs","theme":true,"copy":true,"lang":true,"title":"default","height_limit":200},"search":{"enable":true,"type":"local","href":"https://www.google.com/search?q=site:","domain":null,"path":"search.xml"}};</script>
<script id="async-page-config">window.PAGE_CONFIG = {"isPost":true,"isHome":false,"postUpdate":"2023-08-10 17:08:04"};</script>

<!-- Theme mode css -->
<link data-swup-theme rel="stylesheet" href="/css/index.css?v=2.0.9" id="trm-switch-style">
<script>
    let defaultMode = ASYNC_CONFIG.theme.default !=='auto' ?  ASYNC_CONFIG.theme.default : (window.matchMedia("(prefers-color-scheme: light)").matches ? 'style-light' : 'style-dark')
    let catchMode = localStorage.getItem('theme-mode') || defaultMode;
    let type = catchMode === 'style-dark' ? 'add' : 'remove';
    document.documentElement.classList[type]('dark')
</script>

<!-- CDN -->


    
    



<!-- Site Analytics -->
 
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="The Cabin of Hamzone" type="application/atom+xml">
</head>

<body>

  <!-- app wrapper -->
  <div class="trm-app-frame">

    <!-- page preloader -->
    <div class="trm-preloader">
    <div class="trm-holder">
        <div class="preloader">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
</div>
    <!-- page preloader end -->

    <!-- change mode preloader -->
    <div class="trm-mode-swich-animation-frame">
    <div class="trm-mode-swich-animation">
        <i class="i-sun"><i class="iconfont icon-rijian"></i></i>
        <div class="trm-horizon"></div>
        <i class="i-moon"><i class="iconfont icon-yueduye-yejianmoshi"></i></i>
    </div>
</div>
    <!-- change mode preloader end -->

      <!-- scroll container -->
      <div id="trm-dynamic-content" class="trm-swup-animation">
        <div id="trm-scroll-container" class="trm-scroll-container" data-scroll-container style="opacity: 0">
          <div data-scroll-section id="content" class="trm-scroll-section">

            <div class="locomotive-scroll__sticky-target" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;"></div>

            <!-- top bar -->
            <header class="trm-top-bar" data-scroll data-scroll-sticky data-scroll-target=".locomotive-scroll__sticky-target" data-scroll-offset="-10">
	<div class="container">
		<div class="trm-left-side">
			<!-- logo -->
<a href="/" class="trm-logo-frame trm-anima-link">
    
        <img alt="logo" src="/Logo.svg">
    
    
        <div class="trm-logo-text">
            Hamzone&#39;s<span>Cabin</span>
        </div>
    
</a>
<!-- logo end -->
		</div>
		<div class="trm-right-side">
			<!-- menu -->
<div class="trm-menu">
    <nav>
        <ul>
            
            <li class="menu-item-has-children ">
                <a  href="/" target="">
                    home
                </a>
                
            </li>
            
            <li class="menu-item-has-children ">
                <a data-no-swup href="/categories/" target="">
                    categories
                </a>
                
            </li>
            
            <li class="menu-item-has-children ">
                <a data-no-swup href="/archives/" target="">
                    archives
                </a>
                
            </li>
            
            <li class="menu-item-has-children ">
                <a data-no-swup href="/about/" target="">
                    About
                </a>
                
                <ul>
                    
                    <li>
                        <a  href="/project/" target="">
                            Project
                        </a>
                    </li>
                    
                </ul>
                
            </li>
            
            <li class="menu-item-has-children ">
                <a data-no-swup href="/links/" target="">
                    Links
                </a>
                
            </li>
            
            <li class="menu-item-has-children ">
                <a data-no-swup href="/gallary/" target="">
                    Gallary
                </a>
                
            </li>
            
        </ul>
    </nav>
</div>
<!-- menu end -->
			
    <!-- mode switcher place -->
    <div class="trm-mode-switcher-place">
        <div class="trm-mode-switcher">
            <i class="iconfont icon-rijian"></i>
            <input class="tgl tgl-light" id="trm-swich" type="checkbox">
            <label class="trm-swich" for="trm-swich"></label>
            <i class="iconfont icon-yueduye-yejianmoshi"></i>
        </div>
    </div>
    <!-- mode switcher place end -->

			
    
    <div id="trm-search-btn" class="trm-search-btn">
        <i class="iconfont icon-sousuo"></i>
    </div>
     

		</div>
		<div class="trm-menu-btn">
			<span></span>
		</div>
	</div>
</header>
            <!-- top bar end -->

            <!-- body -->
            
<div class="trm-content-start">
    <!-- banner -->
    <div class="trm-banner" data-scroll data-scroll-direction="vertical">
    
    <!-- banner cover -->
    <img style="object-position:top;object-fit:cover;" alt="banner" class="trm-banner-cover" data-scroll data-scroll-direction="vertical" data-scroll-speed="-3" src="/img/banner.png">
    <!-- banner cover end -->
    

    <!-- banner content -->
    <div class="trm-banner-content trm-overlay">
        <div class="container" data-scroll data-scroll-direction="vertical" data-scroll-speed="0">
            <div class="row">
                
                <div class="col-lg-4"></div>
                
                <div class="col-lg-8">

                    <!-- banner title -->
                    <div class="trm-banner-text ">
                        <div class="trm-label trm-mb-20">
                            NEWS LETTER
                        </div>
                        <h1 class="trm-mb-30 trm-hsmb-font">
                            ECnet代码解读（一）
                        </h1>

                        
                            <ul class="trm-breadcrumbs trm-label">
                                <li>
                                    <a href="/" class="trm-anima-link">Home</a>
                                </li>
                                <li>
                                    <span>
                                        2023
                                    </span
                                ></li>
                            </ul>
                        
                    </div>
                    <!-- banner title end -->

                    <!-- scroll hint -->
                    <a href="#about-triger" data-scroll-to="#about-triger" data-scroll-offset="-130" class="trm-scroll-hint-frame">
                        <div class="trm-scroll-hint"></div>
                        <span class="trm-label">Scroll down</span>
                    </a>
                    <!-- scroll hint end -->

                </div>
            </div>
        </div>
    </div>
    <!-- banner content end -->
</div>
    <!-- banner end -->
    <div class="container">
        <div class="row">
            
                <div id="page-sidebar" class="col-lg-4 hidden-sm">
                    <!-- main card -->
                    

<div class="trm-main-card-frame trm-sidebar">
    <div class="trm-main-card" data-scroll data-scroll-repeat data-scroll-sticky data-scroll-target=".locomotive-scroll__sticky-target" data-scroll-offset="60"> 
    
        <div class="trm-user-tabs" id="sidebar-tabs">
           <div class="trm-tabs-nav trm-mb-40" id="trm-tabs-nav">
                <div data-to="tabs-user" class="trm-tabs-nav-item">
                    <i class="iconfont fas fa-user-alt"></i>
                </div>
                <div data-to="tabs-toc" class="trm-tabs-nav-item active">
                    <i class="iconfont fas fa-th-list"></i>
                </div>
           </div>
            <div name="tabs-user" class="trm-tabs-item">
                <!-- card header -->
<div class="trm-mc-header">
    <div class="trm-avatar-frame trm-mb-20">
        <img alt="Avatar" class="trm-avatar" src="/img/avatar.jpg">
    </div>
    <h5 class="trm-name trm-mb-15">
        Hamzone
    </h5>
    
        <div class="trm-label">
            I`m
            <span class="trm-typed-text">
                <!-- Words for theme.user.typedText -->
            </span>
        </div>
    
</div>
<!-- card header end -->
                <!-- sidebar social -->

<div class="trm-divider trm-mb-40 trm-mt-40"></div>
<div class="trm-social">
    
        <a href="https://github.com/Lhz002" title="github" rel="nofollow" target="_blank">
            <i class="iconfont icon-github-fill"></i>
        </a>
    
        <a href="https://bilibili.com" title="bilibili" rel="nofollow" target="_blank">
            <i class="iconfont icon-bilibili"></i>
        </a>
    
</div>

<!-- sidebar social end -->
                <!-- info -->
<div class="trm-divider trm-mb-40 trm-mt-40"></div>
<ul class="trm-table trm-mb-20">
    
        <li>
            <div class="trm-label">
                Name:
            </div>
            <div class="trm-label trm-label-light">
                Li Hanzhang
            </div>
        </li>
    
        <li>
            <div class="trm-label">
                Location:
            </div>
            <div class="trm-label trm-label-light">
                ZheJiang, China
            </div>
        </li>
    
        <li>
            <div class="trm-label">
                Age:
            </div>
            <div class="trm-label trm-label-light">
                20
            </div>
        </li>
    
        <li>
            <div class="trm-label">
                Email:
            </div>
            <div class="trm-label trm-label-light">
                Lhz1209@outlook.com
            </div>
        </li>
    
</ul>
<!-- info end -->

                
    <div class="trm-divider trm-mb-40 trm-mt-40"></div>
    <!-- action button -->
    <div class="text-center">
        <a href="mailto:Lhz1209@outlook.com" class="trm-btn">
            联系我
            <i class="iconfont icon-youxiang"></i>
        </a>
    </div>
    <!-- action button end -->

            </div>
            <div name="tabs-toc" class="trm-tabs-item active">
                <div class="post-toc">
    <ol class="toc"><li class="toc-item toc-level-1"><a rel="nofollow" class="toc-link" href="#数据处理部分代码"  data-scroll-to="#数据处理部分代码"><span class="toc-number">1.</span> <span class="toc-text">数据处理部分代码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#数据加载和预处理"  data-scroll-to="#数据加载和预处理"><span class="toc-number">1.1.</span> <span class="toc-text">数据加载和预处理</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#编码和数据准备"  data-scroll-to="#编码和数据准备"><span class="toc-number">1.2.</span> <span class="toc-text">编码和数据准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#index-encoding-函数"  data-scroll-to="#index-encoding-函数"><span class="toc-number">1.2.1.</span> <span class="toc-text">index_encoding 函数</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#Dataset-类"  data-scroll-to="#Dataset-类"><span class="toc-number">1.2.2.</span> <span class="toc-text">Dataset 类</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#数据集划分"  data-scroll-to="#数据集划分"><span class="toc-number">1.3.</span> <span class="toc-text">数据集划分</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#突变的写入和读取"  data-scroll-to="#突变的写入和读取"><span class="toc-number">1.4.</span> <span class="toc-text">突变的写入和读取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-mutation-to-sequence-方法"  data-scroll-to="#1-mutation-to-sequence-方法"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. _mutation_to_sequence 方法:</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-mutations-to-sequences-方法"  data-scroll-to="#2-mutations-to-sequences-方法"><span class="toc-number">1.4.2.</span> <span class="toc-text">2. _mutations_to_sequences 方法:</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-drop-invalid-mutation-方法"  data-scroll-to="#3-drop-invalid-mutation-方法"><span class="toc-number">1.4.3.</span> <span class="toc-text">3. _drop_invalid_mutation 方法:</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#4-read-mutation-df-方法"  data-scroll-to="#4-read-mutation-df-方法"><span class="toc-number">1.4.4.</span> <span class="toc-text">4. _read_mutation_df 方法:</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#特征编码和数据载入"  data-scroll-to="#特征编码和数据载入"><span class="toc-number">1.5.</span> <span class="toc-text">特征编码和数据载入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-encode-seq-enc-方法"  data-scroll-to="#1-encode-seq-enc-方法"><span class="toc-number">1.5.1.</span> <span class="toc-text">1. encode_seq_enc 方法:</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-encode-loc-feat-和-encode-glob-feat-方法"  data-scroll-to="#2-encode-loc-feat-和-encode-glob-feat-方法"><span class="toc-number">1.5.2.</span> <span class="toc-text">2. encode_loc_feat 和 encode_glob_feat 方法:</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-build-data-方法"  data-scroll-to="#3-build-data-方法"><span class="toc-number">1.5.3.</span> <span class="toc-text">3. build_data 方法:</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#4-get-dataloader-方法"  data-scroll-to="#4-get-dataloader-方法"><span class="toc-number">1.5.4.</span> <span class="toc-text">4. get_dataloader 方法:</span></a></li></ol></li></ol></li></ol>
</div>
            </div>
        </div>
    
    </div>
</div>
                    <!-- main card end -->
                </div>
            
            <div id="page-content" class="col-lg-8">
                <div class="trm-content" id="trm-content">
                    <div data-scroll data-scroll-repeat data-scroll-offset="500" id="about-triger"></div>

                    <div id="post-info" class="row hidden-sm">
    <div class="col-sm-4">
        <div class="trm-card trm-label trm-label-light text-center">
            <i class="iconfont icon-riqi trm-icon"></i><br>
            08/10
        </div>
    </div>
    <div class="col-sm-4">
        <div class="trm-card trm-label trm-label-light text-center">
            <i class="iconfont icon-shijian trm-icon"></i><br>
            16:22
        </div>
    </div>
    <div class="col-sm-4">
        <div id="post-author" class="trm-card trm-label trm-label-light text-center">
            <i class="iconfont icon-totop trm-icon"></i><br>
            Li Hanzhang
        </div>
    </div>
</div>
<div class="trm-card ">
    <article id="article-container" class="trm-publication">
    <h1 id="数据处理部分代码"><a href="#数据处理部分代码" class="headerlink" title="数据处理部分代码"></a>数据处理部分代码</h1><p>#data.py#</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> Bio <span class="keyword">import</span> SeqIO</span><br><span class="line"><span class="keyword">import</span> torch.utils.data</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> KFold, ShuffleSplit</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ecnet <span class="keyword">import</span> vocab</span><br><span class="line"><span class="keyword">from</span> ecnet.local_feature <span class="keyword">import</span> CCMPredEncoder</span><br><span class="line"><span class="keyword">from</span> ecnet.global_feature <span class="keyword">import</span> TAPEEncoder</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SequenceData</span>(torch.utils.data.Dataset):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, sequences, labels</span>):</span><br><span class="line">        self.sequences = sequences</span><br><span class="line">        self.labels = labels</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.labels)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="keyword">return</span> self.sequences[index], self.labels[index]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MetagenesisData</span>(torch.utils.data.Dataset):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data</span>):</span><br><span class="line">        self.data = data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="keyword">return</span> self.data[index]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index_encoding</span>(<span class="params">sequences</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Modified from https://github.com/openvax/mhcflurry/blob/master/mhcflurry/amino_acid.py#L110-L130</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string">    sequences: list of equal-length sequences</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns</span></span><br><span class="line"><span class="string">    -------</span></span><br><span class="line"><span class="string">    np.array with shape (#sequences, length of sequences)</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    df = pd.DataFrame(<span class="built_in">iter</span>(s) <span class="keyword">for</span> s <span class="keyword">in</span> sequences)</span><br><span class="line">    encoding = df.replace(vocab.AMINO_ACID_INDEX)</span><br><span class="line">    encoding = encoding.values.astype(np.<span class="built_in">int</span>)</span><br><span class="line">    <span class="keyword">return</span> encoding</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dataset</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">            train_tsv=<span class="literal">None</span>, test_tsv=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">            fasta=<span class="literal">None</span>, ccmpred_output=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">            use_loc_feat=<span class="literal">True</span>, use_glob_feat=<span class="literal">True</span>,</span></span><br><span class="line"><span class="params">            split_ratio=[<span class="number">0.9</span>, <span class="number">0.1</span>],</span></span><br><span class="line"><span class="params">            random_seed=<span class="number">42</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        split_ratio: [train, valid] or [train, valid, test]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        self.train_tsv = train_tsv</span><br><span class="line">        self.test_tsv = test_tsv</span><br><span class="line">        self.fasta = fasta</span><br><span class="line">        self.use_loc_feat = use_loc_feat</span><br><span class="line">        self.use_glob_feat = use_glob_feat</span><br><span class="line">        self.split_ratio = split_ratio</span><br><span class="line">        self.rng = np.random.RandomState(random_seed)</span><br><span class="line"></span><br><span class="line">        self.native_sequence = self._read_native_sequence()</span><br><span class="line">        <span class="keyword">if</span> train_tsv <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.full_df = self._read_mutation_df(train_tsv)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.full_df = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> test_tsv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(split_ratio) != <span class="number">3</span>:</span><br><span class="line">                split_ratio = [<span class="number">0.7</span>, <span class="number">0.1</span>, <span class="number">0.2</span>]</span><br><span class="line">                warnings.warn(<span class="string">&quot;\nsplit_ratio should have 3 elements if test_tsv is None.&quot;</span> + \</span><br><span class="line">                    <span class="string">f&quot;Changing split_ratio to <span class="subst">&#123;split_ratio&#125;</span>. &quot;</span> + \</span><br><span class="line">                    <span class="string">&quot;Set to other values using --split_ratio.&quot;</span>)</span><br><span class="line">            self.train_df, self.valid_df, self.test_df = \</span><br><span class="line">                self._split_dataset_df(self.full_df, split_ratio)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(split_ratio) != <span class="number">2</span>:</span><br><span class="line">                split_ratio = [<span class="number">0.9</span>, <span class="number">0.1</span>]</span><br><span class="line">                warnings.warn(<span class="string">&quot;\nsplit_ratio should have 2 elements if test_tsv is provided. &quot;</span> + \</span><br><span class="line">                    <span class="string">f&quot;Changing split_ratio to <span class="subst">&#123;split_ratio&#125;</span>. &quot;</span> + \</span><br><span class="line">                    <span class="string">&quot;Set to other values using --split_ratio.&quot;</span>)</span><br><span class="line">            self.test_df = self._read_mutation_df(test_tsv)</span><br><span class="line">            <span class="keyword">if</span> self.full_df <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                self.train_df, self.valid_df, _ = \</span><br><span class="line">                    self._split_dataset_df(self.full_df, split_ratio)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.full_df <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.train_valid_df = pd.concat(</span><br><span class="line">                [self.train_df, self.valid_df]).reset_index(drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.use_loc_feat:</span><br><span class="line">            self.ccmpred_encoder = CCMPredEncoder(</span><br><span class="line">                ccmpred_output=ccmpred_output, seq_len=<span class="built_in">len</span>(self.native_sequence))</span><br><span class="line">        <span class="keyword">if</span> self.use_glob_feat:</span><br><span class="line">            self.tape_encoder = TAPEEncoder()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_read_native_sequence</span>(<span class="params">self</span>):</span><br><span class="line">        fasta = SeqIO.read(self.fasta, <span class="string">&#x27;fasta&#x27;</span>)</span><br><span class="line">        native_sequence = <span class="built_in">str</span>(fasta.seq)</span><br><span class="line">        <span class="keyword">return</span> native_sequence</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_split_ratio</span>(<span class="params">self, split_ratio</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Modified from: https://github.com/pytorch/text/blob/3d28b1b7c1fb2ddac4adc771207318b0a0f4e4f9/torchtext/data/dataset.py#L284-L311</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        test_ratio = <span class="number">0.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(split_ratio, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">assert</span> <span class="number">0.</span> &lt; split_ratio &lt; <span class="number">1.</span>, (</span><br><span class="line">                <span class="string">&quot;Split ratio &#123;&#125; not between 0 and 1&quot;</span>.<span class="built_in">format</span>(split_ratio))</span><br><span class="line">            valid_ratio = <span class="number">1.</span> - split_ratio</span><br><span class="line">            <span class="keyword">return</span> (split_ratio, valid_ratio, test_ratio)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(split_ratio, <span class="built_in">list</span>):</span><br><span class="line">            length = <span class="built_in">len</span>(split_ratio)</span><br><span class="line">            <span class="keyword">assert</span> length == <span class="number">2</span> <span class="keyword">or</span> length == <span class="number">3</span>, (</span><br><span class="line">                <span class="string">&quot;Length of split ratio list should be 2 or 3, got &#123;&#125;&quot;</span>.<span class="built_in">format</span>(split_ratio))</span><br><span class="line">            ratio_sum = <span class="built_in">sum</span>(split_ratio)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ratio_sum == <span class="number">1.</span>:</span><br><span class="line">                split_ratio = [<span class="built_in">float</span>(ratio) / ratio_sum <span class="keyword">for</span> ratio <span class="keyword">in</span> split_ratio]</span><br><span class="line">            <span class="keyword">if</span> length == <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">tuple</span>(split_ratio + [test_ratio])</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">tuple</span>(split_ratio)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Split ratio must be float or a list, got &#123;&#125;&#x27;</span></span><br><span class="line">                            .<span class="built_in">format</span>(<span class="built_in">type</span>(split_ratio)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_split_dataset_df</span>(<span class="params">self, input_df, split_ratio, resample_split=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Modified from:</span></span><br><span class="line"><span class="string">        https://github.com/pytorch/text/blob/3d28b1b7c1fb2ddac4adc771207318b0a0f4e4f9/torchtext/data/dataset.py#L86-L136</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        _rng = self.rng.randint(<span class="number">512</span>) <span class="keyword">if</span> resample_split <span class="keyword">else</span> self.rng</span><br><span class="line">        df = input_df.copy()</span><br><span class="line">        df = df.sample(frac=<span class="number">1</span>, random_state=_rng).reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">        N = <span class="built_in">len</span>(df)</span><br><span class="line">        train_ratio, valid_ratio, test_ratio = self._check_split_ratio(split_ratio)</span><br><span class="line">        train_len = <span class="built_in">int</span>(<span class="built_in">round</span>(train_ratio * N))</span><br><span class="line">        valid_len = N - train_len <span class="keyword">if</span> <span class="keyword">not</span> test_ratio <span class="keyword">else</span> <span class="built_in">int</span>(<span class="built_in">round</span>(valid_ratio * N))</span><br><span class="line"></span><br><span class="line">        train_df = df.iloc[:train_len].reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">        valid_df = df.iloc[train_len:train_len + valid_len].reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">        test_df = df.iloc[train_len + valid_len:].reset_index(drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> train_df, valid_df, test_df</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_mutation_to_sequence</span>(<span class="params">self, mutation</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Parameters</span></span><br><span class="line"><span class="string">        ----------</span></span><br><span class="line"><span class="string">        mutation: &#x27;;&#x27;.join(WiM) (wide-type W at position i mutated to M)</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        sequence = self.native_sequence</span><br><span class="line">        <span class="keyword">for</span> mut <span class="keyword">in</span> mutation.split(<span class="string">&#x27;;&#x27;</span>):</span><br><span class="line">            wt_aa = mut[<span class="number">0</span>]</span><br><span class="line">            mt_aa = mut[-<span class="number">1</span>]</span><br><span class="line">            pos = <span class="built_in">int</span>(mut[<span class="number">1</span>:-<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">assert</span> wt_aa == sequence[pos - <span class="number">1</span>],\</span><br><span class="line">                    <span class="string">&quot;%s: %s-&gt;%s (fasta WT: %s)&quot;</span>%(pos, wt_aa, mt_aa, sequence[pos - <span class="number">1</span>])</span><br><span class="line">            sequence = sequence[:(pos - <span class="number">1</span>)] + mt_aa + sequence[pos:]</span><br><span class="line">        <span class="keyword">return</span> sequence</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_mutations_to_sequences</span>(<span class="params">self, mutations</span>):</span><br><span class="line">        <span class="keyword">return</span> [self._mutation_to_sequence(m) <span class="keyword">for</span> m <span class="keyword">in</span> mutations]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_drop_invalid_mutation</span>(<span class="params">self, df</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Drop mutations WiM where</span></span><br><span class="line"><span class="string">        - W is incosistent with the i-th AA in native_sequence</span></span><br><span class="line"><span class="string">        - M is ambiguous, e.g., &#x27;X&#x27;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        flags = []</span><br><span class="line">        <span class="keyword">for</span> mutation <span class="keyword">in</span> df[<span class="string">&#x27;mutation&#x27;</span>].values:</span><br><span class="line">            <span class="keyword">for</span> mut <span class="keyword">in</span> mutation.split(<span class="string">&#x27;;&#x27;</span>):</span><br><span class="line">                wt_aa = mut[<span class="number">0</span>]</span><br><span class="line">                mt_aa = mut[-<span class="number">1</span>]</span><br><span class="line">                pos = <span class="built_in">int</span>(mut[<span class="number">1</span>:-<span class="number">1</span>])</span><br><span class="line">                valid = <span class="literal">True</span> <span class="keyword">if</span> wt_aa == self.native_sequence[pos - <span class="number">1</span>] <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line">                valid = valid <span class="keyword">and</span> (mt_aa <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;X&#x27;</span>])</span><br><span class="line">            flags.append(valid)</span><br><span class="line">        df = df[flags].reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> df</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_read_mutation_df</span>(<span class="params">self, tsv</span>):</span><br><span class="line">        df = pd.read_table(tsv)</span><br><span class="line">        df = self._drop_invalid_mutation(df)</span><br><span class="line">        df[<span class="string">&#x27;sequence&#x27;</span>] = self._mutations_to_sequences(df[<span class="string">&#x27;mutation&#x27;</span>].values)</span><br><span class="line">        <span class="keyword">return</span> df</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode_seq_enc</span>(<span class="params">self, sequences</span>):</span><br><span class="line">        seq_enc = index_encoding(sequences)</span><br><span class="line">        seq_enc = torch.from_numpy(seq_enc.astype(np.<span class="built_in">int</span>))</span><br><span class="line">        <span class="keyword">return</span> seq_enc</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode_loc_feat</span>(<span class="params">self, sequences</span>):</span><br><span class="line">        feat = self.ccmpred_encoder.encode(sequences)</span><br><span class="line">        feat = torch.from_numpy(feat).<span class="built_in">float</span>()</span><br><span class="line">        <span class="keyword">return</span> feat</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode_glob_feat</span>(<span class="params">self, sequences</span>):</span><br><span class="line">        feat = self.tape_encoder.encode(sequences)</span><br><span class="line">        feat = torch.from_numpy(feat).<span class="built_in">float</span>()</span><br><span class="line">        <span class="keyword">return</span> feat</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build_data</span>(<span class="params">self, mode, return_df=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">if</span> mode == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">            df = self.train_df.copy()</span><br><span class="line">        <span class="keyword">elif</span> mode == <span class="string">&#x27;valid&#x27;</span>:</span><br><span class="line">            df = self.valid_df.copy()</span><br><span class="line">        <span class="keyword">elif</span> mode == <span class="string">&#x27;test&#x27;</span>:</span><br><span class="line">            df = self.test_df.copy()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">        sequences = df[<span class="string">&#x27;sequence&#x27;</span>].values</span><br><span class="line">        seq_enc = self.encode_seq_enc(sequences)</span><br><span class="line">        <span class="keyword">if</span> self.use_loc_feat:</span><br><span class="line">            loc_feat = self.encode_loc_feat(sequences)</span><br><span class="line">        <span class="keyword">if</span> self.use_glob_feat:</span><br><span class="line">            glob_feat = self.encode_glob_feat(sequences)</span><br><span class="line"></span><br><span class="line">        labels = df[<span class="string">&#x27;score&#x27;</span>].values</span><br><span class="line">        labels = torch.from_numpy(labels.astype(np.float32))</span><br><span class="line"></span><br><span class="line">        samples = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(df)):</span><br><span class="line">            sample = &#123;</span><br><span class="line">                <span class="string">&#x27;sequence&#x27;</span>:sequences[i],</span><br><span class="line">                <span class="string">&#x27;label&#x27;</span>:labels[i],</span><br><span class="line">                <span class="string">&#x27;seq_enc&#x27;</span>: seq_enc[i],</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> self.use_loc_feat:</span><br><span class="line">                sample[<span class="string">&#x27;loc_feat&#x27;</span>] = loc_feat[i]</span><br><span class="line">            <span class="keyword">if</span> self.use_glob_feat:</span><br><span class="line">                sample[<span class="string">&#x27;glob_feat&#x27;</span>] = glob_feat[i]</span><br><span class="line">            samples.append(sample)</span><br><span class="line">        data = MetagenesisData(samples)</span><br><span class="line">        <span class="keyword">if</span> return_df:</span><br><span class="line">            <span class="keyword">return</span> data, df</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_dataloader</span>(<span class="params">self, mode, batch_size=<span class="number">128</span>,</span></span><br><span class="line"><span class="params">            return_df=<span class="literal">False</span>, resample_train_valid=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">if</span> resample_train_valid:</span><br><span class="line">            self.train_df, self.valid_df, _ = \</span><br><span class="line">                self._split_dataset_df(</span><br><span class="line">                    self.train_valid_df, self.split_ratio[:<span class="number">2</span>], resample_split=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mode == <span class="string">&#x27;train_valid&#x27;</span>:</span><br><span class="line">            train_data, train_df = self.build_data(<span class="string">&#x27;train&#x27;</span>, return_df=<span class="literal">True</span>)</span><br><span class="line">            valid_data, valid_df = self.build_data(<span class="string">&#x27;valid&#x27;</span>, return_df=<span class="literal">True</span>)</span><br><span class="line">            train_loader = torch.utils.data.DataLoader(train_data, batch_size=batch_size)</span><br><span class="line">            valid_loader = torch.utils.data.DataLoader(valid_data, batch_size=batch_size)</span><br><span class="line">            <span class="keyword">if</span> return_df:</span><br><span class="line">                <span class="keyword">return</span> (train_loader, train_df), (valid_loader, valid_df)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> train_loader, valid_loader</span><br><span class="line">        <span class="keyword">elif</span> mode == <span class="string">&#x27;test&#x27;</span>:</span><br><span class="line">            test_data, test_df = self.build_data(<span class="string">&#x27;test&#x27;</span>, return_df=<span class="literal">True</span>)</span><br><span class="line">            test_loader = torch.utils.data.DataLoader(test_data, batch_size=batch_size)</span><br><span class="line">            <span class="keyword">if</span> return_df:</span><br><span class="line">                <span class="keyword">return</span> test_loader, test_df</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> test_loader</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    protein_name = <span class="string">&#x27;gb1&#x27;</span></span><br><span class="line">    dataset_name = <span class="string">&#x27;Envision_Gray2018&#x27;</span></span><br><span class="line">    dataset = Dataset(</span><br><span class="line">        train_tsv=<span class="string">f&#x27;../../output/mutagenesis/<span class="subst">&#123;dataset_name&#125;</span>/<span class="subst">&#123;protein_name&#125;</span>/data.tsv&#x27;</span>,</span><br><span class="line">        fasta=<span class="string">f&#x27;../../output/mutagenesis/<span class="subst">&#123;dataset_name&#125;</span>/<span class="subst">&#123;protein_name&#125;</span>/native_sequence.fasta&#x27;</span>,</span><br><span class="line">        ccmpred_output=<span class="string">f&#x27;../../output/homologous/<span class="subst">&#123;dataset_name&#125;</span>/<span class="subst">&#123;protein_name&#125;</span>/hhblits/ccmpred/<span class="subst">&#123;protein_name&#125;</span>.braw&#x27;</span>,</span><br><span class="line">        split_ratio=[<span class="number">0.7</span>, <span class="number">0.1</span>, <span class="number">0.2</span>],</span><br><span class="line">        use_loc_feat=<span class="literal">False</span>, use_glob_feat=<span class="literal">False</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># dataset.build_data(&#x27;train&#x27;)</span></span><br><span class="line">    (loader, df), (_, _) = dataset.get_dataloader(<span class="string">&#x27;train_valid&#x27;</span>,</span><br><span class="line">        batch_size=<span class="number">32</span>, return_df=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(df.head())</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(loader.__iter__()))</span><br><span class="line">    (loader, df), (_, _) = dataset.get_dataloader(<span class="string">&#x27;train_valid&#x27;</span>,</span><br><span class="line">        batch_size=<span class="number">32</span>, return_df=<span class="literal">True</span>, resample_train_valid=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(df.head())</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(loader.__iter__()))</span><br><span class="line">    loader, df = dataset.get_dataloader(<span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">        batch_size=<span class="number">32</span>, return_df=<span class="literal">True</span>, resample_train_valid=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">next</span>(loader.__iter__()))</span><br></pre></td></tr></table></figure>

<h2 id="数据加载和预处理"><a href="#数据加载和预处理" class="headerlink" title="数据加载和预处理"></a>数据加载和预处理</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SequenceData</span>(torch.utils.data.Dataset):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, sequences, labels</span>):</span><br><span class="line">        self.sequences = sequences</span><br><span class="line">        self.labels = labels</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.labels)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="keyword">return</span> self.sequences[index], self.labels[index]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MetagenesisData</span>(torch.utils.data.Dataset):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data</span>):</span><br><span class="line">        self.data = data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="keyword">return</span> self.data[index]</span><br></pre></td></tr></table></figure>

<ol>
<li><strong><code>SequenceData</code> 类</strong>：<ul>
<li>**<code>__init__(self, sequences, labels)</code>**：构造函数接受序列和标签作为输入，并将它们存储为类的属性。序列可以是一系列的特征向量，标签通常是相应的目标值或类别标签。</li>
<li>**<code>__len__(self)</code>**：此方法返回数据集的大小，即标签的数量。这对于迭代和批量处理数据集非常重要。</li>
<li>**<code>__getitem__(self, index)</code>**：此方法允许通过索引访问数据集中的特定项。返回的是给定索引处的序列和标签。</li>
</ul>
</li>
<li><strong><code>MetagenesisData</code> 类</strong>：<ul>
<li>**<code>__init__(self, data)</code>**：构造函数接受数据作为输入，并将其存储为类的属性。这些数据可能是一个复杂的结构，包括特征和标签。</li>
<li>**<code>__len__(self)</code>**：和上面一样，此方法返回数据集的大小。</li>
<li>**<code>__getitem__(self, index)</code>**：此方法允许通过索引访问数据集中的特定项。返回的是给定索引处的数据项。</li>
</ul>
</li>
</ol>
<p>这两个类的主要作用是封装数据，并提供一种标准化的方式来访问和迭代数据。这对于训练和评估机器学习模型非常重要，因为它允许模型以一致的方式处理数据，而无需关心数据的底层表示和结构。</p>
<p>通过将数据封装在这些类中，可以更容易地与 PyTorch 的其他组件（例如 DataLoader）集成，从而实现数据的批量加载、随机抽样和多线程加载等功能。这有助于提高训练和评估过程的效率和灵活性。</p>
<h2 id="编码和数据准备"><a href="#编码和数据准备" class="headerlink" title="编码和数据准备"></a>编码和数据准备</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">index_encoding</span>(<span class="params">sequences</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Modified from https://github.com/openvax/mhcflurry/blob/master/mhcflurry/amino_acid.py#L110-L130</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string">    sequences: list of equal-length sequences</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns</span></span><br><span class="line"><span class="string">    -------</span></span><br><span class="line"><span class="string">    np.array with shape (#sequences, length of sequences)</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    df = pd.DataFrame(<span class="built_in">iter</span>(s) <span class="keyword">for</span> s <span class="keyword">in</span> sequences)</span><br><span class="line">    encoding = df.replace(vocab.AMINO_ACID_INDEX)</span><br><span class="line">    encoding = encoding.values.astype(np.<span class="built_in">int</span>)</span><br><span class="line">    <span class="keyword">return</span> encoding</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dataset</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">            train_tsv=<span class="literal">None</span>, test_tsv=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">            fasta=<span class="literal">None</span>, ccmpred_output=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">            use_loc_feat=<span class="literal">True</span>, use_glob_feat=<span class="literal">True</span>,</span></span><br><span class="line"><span class="params">            split_ratio=[<span class="number">0.9</span>, <span class="number">0.1</span>],</span></span><br><span class="line"><span class="params">            random_seed=<span class="number">42</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        split_ratio: [train, valid] or [train, valid, test]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        self.train_tsv = train_tsv</span><br><span class="line">        self.test_tsv = test_tsv</span><br><span class="line">        self.fasta = fasta</span><br><span class="line">        self.use_loc_feat = use_loc_feat</span><br><span class="line">        self.use_glob_feat = use_glob_feat</span><br><span class="line">        self.split_ratio = split_ratio</span><br><span class="line">        self.rng = np.random.RandomState(random_seed)</span><br><span class="line"></span><br><span class="line">        self.native_sequence = self._read_native_sequence()</span><br><span class="line">        <span class="keyword">if</span> train_tsv <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.full_df = self._read_mutation_df(train_tsv)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.full_df = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> test_tsv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(split_ratio) != <span class="number">3</span>:</span><br><span class="line">                split_ratio = [<span class="number">0.7</span>, <span class="number">0.1</span>, <span class="number">0.2</span>]</span><br><span class="line">                warnings.warn(<span class="string">&quot;\nsplit_ratio should have 3 elements if test_tsv is None.&quot;</span> + \</span><br><span class="line">                    <span class="string">f&quot;Changing split_ratio to <span class="subst">&#123;split_ratio&#125;</span>. &quot;</span> + \</span><br><span class="line">                    <span class="string">&quot;Set to other values using --split_ratio.&quot;</span>)</span><br><span class="line">            self.train_df, self.valid_df, self.test_df = \</span><br><span class="line">                self._split_dataset_df(self.full_df, split_ratio)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(split_ratio) != <span class="number">2</span>:</span><br><span class="line">                split_ratio = [<span class="number">0.9</span>, <span class="number">0.1</span>]</span><br><span class="line">                warnings.warn(<span class="string">&quot;\nsplit_ratio should have 2 elements if test_tsv is provided. &quot;</span> + \</span><br><span class="line">                    <span class="string">f&quot;Changing split_ratio to <span class="subst">&#123;split_ratio&#125;</span>. &quot;</span> + \</span><br><span class="line">                    <span class="string">&quot;Set to other values using --split_ratio.&quot;</span>)</span><br><span class="line">            self.test_df = self._read_mutation_df(test_tsv)</span><br><span class="line">            <span class="keyword">if</span> self.full_df <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                self.train_df, self.valid_df, _ = \</span><br><span class="line">                    self._split_dataset_df(self.full_df, split_ratio)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.full_df <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.train_valid_df = pd.concat(</span><br><span class="line">                [self.train_df, self.valid_df]).reset_index(drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.use_loc_feat:</span><br><span class="line">            self.ccmpred_encoder = CCMPredEncoder(</span><br><span class="line">                ccmpred_output=ccmpred_output, seq_len=<span class="built_in">len</span>(self.native_sequence))</span><br><span class="line">        <span class="keyword">if</span> self.use_glob_feat:</span><br><span class="line">            self.tape_encoder = TAPEEncoder()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_read_native_sequence</span>(<span class="params">self</span>):</span><br><span class="line">        fasta = SeqIO.read(self.fasta, <span class="string">&#x27;fasta&#x27;</span>)</span><br><span class="line">        native_sequence = <span class="built_in">str</span>(fasta.seq)</span><br><span class="line">        <span class="keyword">return</span> native_sequence</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="index-encoding-函数"><a href="#index-encoding-函数" class="headerlink" title="index_encoding 函数"></a><code>index_encoding</code> 函数</h3><p>这个函数用于将氨基酸序列转换为整数索引编码。</p>
<ul>
<li><strong>参数</strong>：<code>sequences</code> - 等长序列的列表。</li>
<li><strong>返回值</strong>：整数编码的 NumPy 数组，形状为 (#序列, 序列长度)。</li>
</ul>
<p>流程：</p>
<ol>
<li>使用 Pandas 的 DataFrame 将序列转换为表格形式。</li>
<li>使用 <code>vocab.AMINO_ACID_INDEX</code> 替换 DataFrame 中的值，将氨基酸转换为对应的索引。</li>
<li>将结果转换为整数类型的 NumPy 数组并返回。</li>
</ol>
<h3 id="Dataset-类"><a href="#Dataset-类" class="headerlink" title="Dataset 类"></a><code>Dataset</code> 类</h3><p>这个类是一个数据集的容器，用于存储和管理数据。</p>
<ul>
<li><strong>构造函数</strong>：接受许多参数，包括训练和测试的 TSV 文件路径、FASTA 文件路径、CCMPred 输出、本地特征和全局特征的使用、数据集的划分比例以及随机种子。</li>
</ul>
<p>流程：</p>
<ol>
<li>初始化参数和随机数生成器。</li>
<li>读取本地序列（通过 <code>_read_native_sequence</code> 方法）。</li>
<li>根据提供的 TSV 文件读取训练和测试数据。</li>
<li>根据 <code>split_ratio</code> 对数据进行划分。</li>
<li>如果使用本地特征，则初始化 CCMPred 编码器；如果使用全局特征，则初始化 TAPE 编码器。</li>
</ol>
<h4 id="read-native-sequence-方法"><a href="#read-native-sequence-方法" class="headerlink" title="_read_native_sequence 方法"></a><code>_read_native_sequence</code> 方法</h4><p>这个私有方法用于从 FASTA 文件中读取本地序列，并将其转换为字符串格式。</p>
<h2 id="数据集划分"><a href="#数据集划分" class="headerlink" title="数据集划分"></a>数据集划分</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_split_dataset_df</span>(<span class="params">self, input_df, split_ratio, resample_split=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Modified from:</span></span><br><span class="line"><span class="string">    https://github.com/pytorch/text/blob/3d28b1b7c1fb2ddac4adc771207318b0a0f4e4f9/torchtext/data/dataset.py#L86-L136</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    _rng = self.rng.randint(<span class="number">512</span>) <span class="keyword">if</span> resample_split <span class="keyword">else</span> self.rng</span><br><span class="line">    df = input_df.copy()</span><br><span class="line">    df = df.sample(frac=<span class="number">1</span>, random_state=_rng).reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">    N = <span class="built_in">len</span>(df)</span><br><span class="line">    train_ratio, valid_ratio, test_ratio = self._check_split_ratio(split_ratio)</span><br><span class="line">    train_len = <span class="built_in">int</span>(<span class="built_in">round</span>(train_ratio * N))</span><br><span class="line">    valid_len = N - train_len <span class="keyword">if</span> <span class="keyword">not</span> test_ratio <span class="keyword">else</span> <span class="built_in">int</span>(<span class="built_in">round</span>(valid_ratio * N))</span><br><span class="line"></span><br><span class="line">    train_df = df.iloc[:train_len].reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">    valid_df = df.iloc[train_len:train_len + valid_len].reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">    test_df = df.iloc[train_len + valid_len:].reset_index(drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> train_df, valid_df, test_df</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>参数</strong>：<ul>
<li><code>input_df</code>：要划分的 Pandas DataFrame。</li>
<li><code>split_ratio</code>：一个包含划分比例的列表，如 <code>[0.7, 0.1, 0.2]</code>。</li>
<li><code>resample_split</code>：一个布尔值，如果为 <code>True</code>，则在划分数据之前重新采样随机种子。</li>
</ul>
</li>
<li><strong>流程</strong>：<ol>
<li>通过调用 <code>self.rng.randint(512)</code> 创建一个随机数生成器 <code>_rng</code>，或者使用现有的随机数生成器 <code>self.rng</code>。</li>
<li>复制输入的 DataFrame。</li>
<li>使用 <code>_rng</code> 随机化 DataFrame 的行顺序。</li>
<li>计算训练、验证和测试集的大小。首先通过调用 <code>_check_split_ratio</code> 方法验证和解析 <code>split_ratio</code>。然后，基于这些比例计算每个子集的长度。</li>
<li>使用 Pandas 的 <code>iloc</code> 方法，根据计算出的长度从随机化的 DataFrame 中切分训练、验证和测试集。</li>
<li>重置每个子集的索引并返回。</li>
</ol>
</li>
<li><strong>返回值</strong>：三个 DataFrame，分别代表训练集、验证集和测试集。</li>
</ul>
<h2 id="突变的写入和读取"><a href="#突变的写入和读取" class="headerlink" title="突变的写入和读取"></a>突变的写入和读取</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_mutation_to_sequence</span>(<span class="params">self, mutation</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string">    mutation: &#x27;;&#x27;.join(WiM) (wide-type W at position i mutated to M)</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    sequence = self.native_sequence</span><br><span class="line">    <span class="keyword">for</span> mut <span class="keyword">in</span> mutation.split(<span class="string">&#x27;;&#x27;</span>):</span><br><span class="line">        wt_aa = mut[<span class="number">0</span>]</span><br><span class="line">        mt_aa = mut[-<span class="number">1</span>]</span><br><span class="line">        pos = <span class="built_in">int</span>(mut[<span class="number">1</span>:-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">assert</span> wt_aa == sequence[pos - <span class="number">1</span>],\</span><br><span class="line">                <span class="string">&quot;%s: %s-&gt;%s (fasta WT: %s)&quot;</span>%(pos, wt_aa, mt_aa, sequence[pos - <span class="number">1</span>])</span><br><span class="line">        sequence = sequence[:(pos - <span class="number">1</span>)] + mt_aa + sequence[pos:]</span><br><span class="line">    <span class="keyword">return</span> sequence</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_mutations_to_sequences</span>(<span class="params">self, mutations</span>):</span><br><span class="line">    <span class="keyword">return</span> [self._mutation_to_sequence(m) <span class="keyword">for</span> m <span class="keyword">in</span> mutations]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_drop_invalid_mutation</span>(<span class="params">self, df</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Drop mutations WiM where</span></span><br><span class="line"><span class="string">    - W is incosistent with the i-th AA in native_sequence</span></span><br><span class="line"><span class="string">    - M is ambiguous, e.g., &#x27;X&#x27;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    flags = []</span><br><span class="line">    <span class="keyword">for</span> mutation <span class="keyword">in</span> df[<span class="string">&#x27;mutation&#x27;</span>].values:</span><br><span class="line">        <span class="keyword">for</span> mut <span class="keyword">in</span> mutation.split(<span class="string">&#x27;;&#x27;</span>):</span><br><span class="line">            wt_aa = mut[<span class="number">0</span>]</span><br><span class="line">            mt_aa = mut[-<span class="number">1</span>]</span><br><span class="line">            pos = <span class="built_in">int</span>(mut[<span class="number">1</span>:-<span class="number">1</span>])</span><br><span class="line">            valid = <span class="literal">True</span> <span class="keyword">if</span> wt_aa == self.native_sequence[pos - <span class="number">1</span>] <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line">            valid = valid <span class="keyword">and</span> (mt_aa <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;X&#x27;</span>])</span><br><span class="line">        flags.append(valid)</span><br><span class="line">    df = df[flags].reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> df</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_read_mutation_df</span>(<span class="params">self, tsv</span>):</span><br><span class="line">    df = pd.read_table(tsv)</span><br><span class="line">    df = self._drop_invalid_mutation(df)</span><br><span class="line">    df[<span class="string">&#x27;sequence&#x27;</span>] = self._mutations_to_sequences(df[<span class="string">&#x27;mutation&#x27;</span>].values)</span><br><span class="line">    <span class="keyword">return</span> df</span><br></pre></td></tr></table></figure>



<h3 id="1-mutation-to-sequence-方法"><a href="#1-mutation-to-sequence-方法" class="headerlink" title="1. _mutation_to_sequence 方法:"></a>1. <code>_mutation_to_sequence</code> 方法:</h3><ul>
<li><p><strong>目的</strong>：将一个突变描述转换为一个完整的氨基酸序列。</p>
</li>
<li><p><strong>参数</strong>：<code>mutation</code> - 描述单个或多个突变的字符串，例如 “A5T;F10Y” 表示位置5的A突变为T，位置10的F突变为Y。</p>
</li>
<li><p>流程</p>
<p>：</p>
<ul>
<li><p>从原始的 <code>native_sequence</code> 开始。</p>
</li>
<li><p>对于 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mutation</span><br></pre></td></tr></table></figure>

<p> 中的每个突变：</p>
<ul>
<li>检查突变是否与 <code>native_sequence</code> 中的氨基酸相匹配。</li>
<li>如果相匹配，则在序列中应用突变。</li>
</ul>
</li>
<li><p>返回突变后的序列。</p>
</li>
</ul>
</li>
</ul>
<h3 id="2-mutations-to-sequences-方法"><a href="#2-mutations-to-sequences-方法" class="headerlink" title="2. _mutations_to_sequences 方法:"></a>2. <code>_mutations_to_sequences</code> 方法:</h3><ul>
<li><p><strong>目的</strong>：将多个突变描述转换为多个氨基酸序列。</p>
</li>
<li><p><strong>参数</strong>：<code>mutations</code> - 描述多个突变的字符串列表。</p>
</li>
<li><p>流程</p>
<p>：</p>
<ul>
<li>对于每个突变描述，调用 <code>_mutation_to_sequence</code> 方法并收集结果。</li>
</ul>
</li>
</ul>
<h3 id="3-drop-invalid-mutation-方法"><a href="#3-drop-invalid-mutation-方法" class="headerlink" title="3. _drop_invalid_mutation 方法:"></a>3. <code>_drop_invalid_mutation</code> 方法:</h3><ul>
<li><p><strong>目的</strong>：从 DataFrame 中删除无效的突变。</p>
</li>
<li><p><strong>参数</strong>：<code>df</code> - 包含突变描述的 DataFrame。</p>
</li>
<li><p>流程</p>
<p>：</p>
<ul>
<li>对于每个突变描述：<ul>
<li>检查突变是否与 <code>native_sequence</code> 中的氨基酸相匹配。</li>
<li>检查突变是否为不明确的氨基酸，例如 “X”。</li>
</ul>
</li>
<li>基于上述检查结果，保留有效的突变，并从 DataFrame 中删除无效的突变。</li>
</ul>
</li>
</ul>
<h3 id="4-read-mutation-df-方法"><a href="#4-read-mutation-df-方法" class="headerlink" title="4. _read_mutation_df 方法:"></a>4. <code>_read_mutation_df</code> 方法:</h3><ul>
<li><p><strong>目的</strong>：从 TSV 文件中读取突变数据，并转换为相应的氨基酸序列。</p>
</li>
<li><p><strong>参数</strong>：<code>tsv</code> - TSV 文件的路径。</p>
</li>
<li><p>流程</p>
<p>：</p>
<ul>
<li>使用 Pandas 从文件中读取数据。</li>
<li>调用 <code>_drop_invalid_mutation</code> 方法，去除无效的突变。</li>
<li>调用 <code>_mutations_to_sequences</code> 方法，将突变转换为相应的氨基酸序列，并将其添加到 DataFrame 中。</li>
</ul>
</li>
</ul>
<h2 id="特征编码和数据载入"><a href="#特征编码和数据载入" class="headerlink" title="特征编码和数据载入"></a>特征编码和数据载入</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">encode_seq_enc</span>(<span class="params">self, sequences</span>):</span><br><span class="line">    seq_enc = index_encoding(sequences)</span><br><span class="line">    seq_enc = torch.from_numpy(seq_enc.astype(np.<span class="built_in">int</span>))</span><br><span class="line">    <span class="keyword">return</span> seq_enc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_loc_feat</span>(<span class="params">self, sequences</span>):</span><br><span class="line">    feat = self.ccmpred_encoder.encode(sequences)</span><br><span class="line">    feat = torch.from_numpy(feat).<span class="built_in">float</span>()</span><br><span class="line">    <span class="keyword">return</span> feat</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_glob_feat</span>(<span class="params">self, sequences</span>):</span><br><span class="line">    feat = self.tape_encoder.encode(sequences)</span><br><span class="line">    feat = torch.from_numpy(feat).<span class="built_in">float</span>()</span><br><span class="line">    <span class="keyword">return</span> feat</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_data</span>(<span class="params">self, mode, return_df=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">        df = self.train_df.copy()</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">&#x27;valid&#x27;</span>:</span><br><span class="line">        df = self.valid_df.copy()</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">&#x27;test&#x27;</span>:</span><br><span class="line">        df = self.test_df.copy()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    sequences = df[<span class="string">&#x27;sequence&#x27;</span>].values</span><br><span class="line">    seq_enc = self.encode_seq_enc(sequences)</span><br><span class="line">    <span class="keyword">if</span> self.use_loc_feat:</span><br><span class="line">        loc_feat = self.encode_loc_feat(sequences)</span><br><span class="line">    <span class="keyword">if</span> self.use_glob_feat:</span><br><span class="line">        glob_feat = self.encode_glob_feat(sequences)</span><br><span class="line"></span><br><span class="line">    labels = df[<span class="string">&#x27;score&#x27;</span>].values</span><br><span class="line">    labels = torch.from_numpy(labels.astype(np.float32))</span><br><span class="line"></span><br><span class="line">    samples = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(df)):</span><br><span class="line">        sample = &#123;</span><br><span class="line">            <span class="string">&#x27;sequence&#x27;</span>:sequences[i],</span><br><span class="line">            <span class="string">&#x27;label&#x27;</span>:labels[i],</span><br><span class="line">            <span class="string">&#x27;seq_enc&#x27;</span>: seq_enc[i],</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> self.use_loc_feat:</span><br><span class="line">            sample[<span class="string">&#x27;loc_feat&#x27;</span>] = loc_feat[i]</span><br><span class="line">        <span class="keyword">if</span> self.use_glob_feat:</span><br><span class="line">            sample[<span class="string">&#x27;glob_feat&#x27;</span>] = glob_feat[i]</span><br><span class="line">        samples.append(sample)</span><br><span class="line">    data = MetagenesisData(samples)</span><br><span class="line">    <span class="keyword">if</span> return_df:</span><br><span class="line">        <span class="keyword">return</span> data, df</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_dataloader</span>(<span class="params">self, mode, batch_size=<span class="number">128</span>,</span></span><br><span class="line"><span class="params">        return_df=<span class="literal">False</span>, resample_train_valid=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> resample_train_valid:</span><br><span class="line">        self.train_df, self.valid_df, _ = \</span><br><span class="line">            self._split_dataset_df(</span><br><span class="line">                self.train_valid_df, self.split_ratio[:<span class="number">2</span>], resample_split=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">&#x27;train_valid&#x27;</span>:</span><br><span class="line">        train_data, train_df = self.build_data(<span class="string">&#x27;train&#x27;</span>, return_df=<span class="literal">True</span>)</span><br><span class="line">        valid_data, valid_df = self.build_data(<span class="string">&#x27;valid&#x27;</span>, return_df=<span class="literal">True</span>)</span><br><span class="line">        train_loader = torch.utils.data.DataLoader(train_data, batch_size=batch_size)</span><br><span class="line">        valid_loader = torch.utils.data.DataLoader(valid_data, batch_size=batch_size)</span><br><span class="line">        <span class="keyword">if</span> return_df:</span><br><span class="line">            <span class="keyword">return</span> (train_loader, train_df), (valid_loader, valid_df)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> train_loader, valid_loader</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">&#x27;test&#x27;</span>:</span><br><span class="line">        test_data, test_df = self.build_data(<span class="string">&#x27;test&#x27;</span>, return_df=<span class="literal">True</span>)</span><br><span class="line">        test_loader = torch.utils.data.DataLoader(test_data, batch_size=batch_size)</span><br><span class="line">        <span class="keyword">if</span> return_df:</span><br><span class="line">            <span class="keyword">return</span> test_loader, test_df</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> test_loader</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br></pre></td></tr></table></figure>



<h3 id="1-encode-seq-enc-方法"><a href="#1-encode-seq-enc-方法" class="headerlink" title="1. encode_seq_enc 方法:"></a>1. <code>encode_seq_enc</code> 方法:</h3><ul>
<li><p><strong>目的</strong>：将氨基酸序列转换为整数索引编码。</p>
</li>
<li><p><strong>参数</strong>：<code>sequences</code> - 氨基酸序列的列表。</p>
</li>
<li><p>流程</p>
<p>：</p>
<ul>
<li>调用之前定义的 <code>index_encoding</code> 函数来获取整数编码。</li>
<li>将 NumPy 数组转换为 PyTorch 张量并返回。</li>
</ul>
</li>
</ul>
<h3 id="2-encode-loc-feat-和-encode-glob-feat-方法"><a href="#2-encode-loc-feat-和-encode-glob-feat-方法" class="headerlink" title="2. encode_loc_feat 和 encode_glob_feat 方法:"></a>2. <code>encode_loc_feat</code> 和 <code>encode_glob_feat</code> 方法:</h3><ul>
<li><p><strong>目的</strong>：使用 CCMPred 编码器和 TAPE 编码器对序列进行本地和全局特征编码。</p>
</li>
<li><p><strong>参数</strong>：<code>sequences</code> - 氨基酸序列的列表。</p>
</li>
<li><p>流程</p>
<p>：</p>
<ul>
<li>调用编码器的 <code>encode</code> 方法来获取特征。</li>
<li>将特征转换为 PyTorch 张量并返回。</li>
</ul>
</li>
</ul>
<h3 id="3-build-data-方法"><a href="#3-build-data-方法" class="headerlink" title="3. build_data 方法:"></a>3. <code>build_data</code> 方法:</h3><ul>
<li><p><strong>目的</strong>：根据给定的模式（训练、验证或测试）构建数据集。</p>
</li>
<li><p><strong>参数</strong>：<code>mode</code> - 指定要构建的数据集类型；<code>return_df</code> - 如果为 <code>True</code>，则返回原始 DataFrame。</p>
</li>
<li><p>流程</p>
<p>：</p>
<ul>
<li>根据模式复制相应的 DataFrame。</li>
<li>对序列进行整数索引编码。</li>
<li>如果使用，对序列进行本地和全局特征编码。</li>
<li>从 DataFrame 中提取标签，并转换为 PyTorch 张量。</li>
<li>创建样本字典并收集。</li>
<li>使用 <code>MetagenesisData</code> 类创建数据集。</li>
<li>返回数据集（和可选的 DataFrame）。</li>
</ul>
</li>
</ul>
<h3 id="4-get-dataloader-方法"><a href="#4-get-dataloader-方法" class="headerlink" title="4. get_dataloader 方法:"></a>4. <code>get_dataloader</code> 方法:</h3><ul>
<li><p><strong>目的</strong>：根据给定的模式和批量大小构建数据加载器。</p>
</li>
<li><p><strong>参数</strong>：<code>mode</code>, <code>batch_size</code>, <code>return_df</code>, <code>resample_train_valid</code>。</p>
</li>
<li><p>流程</p>
<p>：</p>
<ul>
<li>如果重新采样，重新划分训练和验证集。</li>
<li>根据模式构建数据集。</li>
<li>使用 PyTorch 的 <code>DataLoader</code> 创建数据加载器。</li>
<li>返回数据加载器（和可选的 DataFrame）。</li>
</ul>
</li>
</ul>

</article>
    
    <div class="trm-reward">
        
            <span class="trm-reward-btn trm-glow" onclick='var qr = document.getElementById("qr"); qr.style.display = (qr.style.display === "none") ? "block" : "none";'>
                <i class="iconfont icon-dashang"></i>
            </span>
        
        <p class="trm-reward-comment">I'm so cute. Please give me money.</p>
        <div id="qr" style="display:none;">
            
                <div style="display:inline-block">
                    <a rel="noopener noreferrer" href='' target='_blank' >
                       <img src="/null" alt="支付宝" loading="lazy">
                    </a>
                    <p>支付宝</p>
                </div>
            
        </div>
    </div>

    

</div>
<div id="post-next-prev" class="row">
    <div class="col-lg-12">
        <!-- title -->
        <h5 class="trm-title-with-divider">
            其他文章
            <span data-number="02"></span>
        </h5>
    </div>
    
        <div class="col-lg-6">
    <div class="trm-blog-card trm-scroll-animation" data-scroll data-scroll-offset="40">
        <a href="/2023/08/10/ECnet%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%8C%EF%BC%89/" class="trm-cover-frame trm-anima-link">
            
            
                <img alt="cover" class="no-fancybox" src="/img/block.jpg">
            
        </a>
        
        <div class="trm-card-descr">
            <div class="trm-label trm-category trm-mb-20">
                <a href=" /categories/%E6%8A%80%E6%9C%AF%E7%B1%BB/">
                    技术类
                </a>
            </div>
            <h5>
                <a href="/2023/08/10/ECnet%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%8C%EF%BC%89/" class="trm-anima-link">
                    ECnet代码解读（二）
                </a>
            </h5>
            <div class="trm-divider trm-mb-20 trm-mt-20"></div>
            <ul class="trm-card-data trm-label">
                <li>23/08/10</li>
                <li>17:07</li>
                
                    <li>2.9k</li>
                
                
                    <li>13</li>
                
            </ul>
        </div>
    </div>
</div>
    
    
        <div class="col-lg-6">
    <div class="trm-blog-card trm-scroll-animation" data-scroll data-scroll-offset="40">
        <a href="/2023/07/30/%E6%96%87%E7%8C%AE%E9%98%85%E8%AF%BB%EF%BC%9A%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E4%B8%8B%E7%9A%84%E9%85%B6%E5%B7%A5%E7%A8%8B/" class="trm-cover-frame trm-anima-link">
            
            
                <img alt="cover" class="no-fancybox" src="/img/block.jpg">
            
        </a>
        
        <div class="trm-card-descr">
            <div class="trm-label trm-category trm-mb-20">
                <a href=" /categories/%E6%96%87%E7%8C%AE%E9%98%85%E8%AF%BB%E7%B1%BB/">
                    文献阅读类
                </a>
            </div>
            <h5>
                <a href="/2023/07/30/%E6%96%87%E7%8C%AE%E9%98%85%E8%AF%BB%EF%BC%9A%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E4%B8%8B%E7%9A%84%E9%85%B6%E5%B7%A5%E7%A8%8B/" class="trm-anima-link">
                    文献阅读：人工智能下的酶工程
                </a>
            </h5>
            <div class="trm-divider trm-mb-20 trm-mt-20"></div>
            <ul class="trm-card-data trm-label">
                <li>23/07/30</li>
                <li>16:22</li>
                
                    <li>3.2k</li>
                
                
                    <li>11</li>
                
            </ul>
        </div>
    </div>
</div>
    
</div>

    



                    <div class="trm-divider footer-divider"></div>

                    <!-- footer -->
                    <footer class="trm-scroll-animation" data-scroll data-scroll-offset="50">

    

    

    
        <div class="trm-footer-item">
            <span>
                由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v6.3.0
            </span>
            <span class="footer-separator" data-separator=" | "></span>
            <span> 
                主题 - 
                <a rel="noopener" href='https://github.com/MaLuns/hexo-theme-async' target='_blank'>Async</a>
                v2.0.9
            </span>
        </div>
      

     

     
</footer>
 
                    <!-- footer end -->

                </div>
            </div>
        </div>
    </div>
</div>
            <!-- body end -->

            <div class="trm-fixed-container" data-scroll data-scroll-sticky data-scroll-target=".locomotive-scroll__sticky-target" data-scroll-offset="-10">
    
        <div class="trm-fixed-btn" data-title="阅读模式" onclick="asyncFun.switchReadMode()">
            <i class="iconfont icon-read"></i>
        </div>
    
    
        <div class="trm-fixed-btn" data-title="单栏和双栏切换" onclick="asyncFun.switchSingleColumn()">
            <i class="iconfont icon-shangxiazhankai"></i>
        </div>
    
    <div id="trm-back-top" class="trm-fixed-btn" data-title="回到顶部">
        <i class="iconfont fas fa-arrow-up"></i>
    </div>
</div>
          </div>
        </div>
      </div>
      <!-- scroll container end -->

  </div>
  <!-- app wrapper end -->

  
    <div class="trm-search-popup">
        <div class="trm-search-wrapper">
            <div class="form trm-search-form">
                <div class="trm-search-input-icon">
                    <i class="iconfont icon-sousuo"></i>
                </div>
                <input class="trm-search-input" type="text" placeholder="搜索文章...">
                <div class="trm-search-btn-close">
                    <i class="iconfont icon-anniu_guanbi"></i>
                </div>
            </div>
            <div class="trm-search-result-container">
                <div class="trm-search-empty">
                    请输入关键词进行搜索
                </div>
            </div>
            <div class="trm-search-footer">
                <div class="trm-search-stats"></div>
                <ul class="trm-search-commands">
                    <li>
                        <kbd class="command-palette-commands-key">
                            <svg width="15" height="15" aria-label="Escape key" role="img">
                                <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="1.2">
                                    <path
                                        d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993 0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016.8634 0 1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5c.032.5663-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864 0 1.6425 1.031 1.5443 2.2492h-2.956">
                                    </path>
                                </g>
                            </svg>
                        </kbd>
                        <span class="command-palette-Label">to close</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

  <!-- Plugin -->




    
    
<script src="https://npm.elemecdn.com/locomotive-scroll@4.1.4/dist/locomotive-scroll.min.js"></script>

    
<script src="https://npm.elemecdn.com/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script>

    

    
        <script src="/js/plugins/typing.js?v=2.0.9"></script>
    

    
        
<script src="https://npm.elemecdn.com/hexo-generator-searchdb@1.4.0/dist/search.js"></script>

        <script src="/js/plugins/local_search.js?v=2.0.9"></script>
    

    <!-- 数学公式 -->
    

    <!-- 评论插件 -->
    
        

        
    



<!-- CDN -->


    

    

    




    <!-- Service Worker -->
    
    <!-- baidu push -->
    


<script id="async-script" src="/js/main.js?v=2.0.9"></script>

<script src="https://unpkg.com/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://unpkg.com/live2d-widget-model-wanko@1.0.5/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>

</html>